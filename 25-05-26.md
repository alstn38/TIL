### In App Purchase

- storeKit 버전 1, 2
- 소모품(웹툰 쿠키) vs 비소모품(광고 제거, 테마)
- 구독(자동갱신/X) →

### 인앱 결제 특성

- 앱이 존재하지 않으면, 인앱 상품이 있을 수 없음
- 인앱결제 상품을 애플 서버 내에서 관리
- 인앱결제 ID를 앱스토어커텍트에서 미리 정의, 정의된 상품을 조회
- 유료 개발자 계정 필요
- TestFlight/SandBox를 통해 결제 테스트를 진행
- 인앱결제 시 영수증을 통해 인앱 유효성 검증

오프라인 모드에서 인앱 결제가 될까? → 영수증 검증, 가능하다.

### 인앱 결제 정책

- 개발자 계정의 모든 앱 기준 최대 10,000개의 앱 내 구입 제품 생성 가능 (앱 다 합쳐서 만개)
- 사용자 경험을 위해, 국자/지역 설정 불가능
- 앱 내 구입 추가 > 앱 업데이트 필요
- 앱 내 구입 삭제 > 최소 31일 전 공지, 프로모션 종료
- 프로모션 > iMessage 불가능
- 유니버셜 > 일부 플랫폼에 대한 인앱 상품 제거 불가능
- 가족공유 > 자동 갱신 구독 및 비소모품에 해당 / 가족공유 설정 변경 불가능


3번을 다시 요청하는 이유?

- 그 순간 선물을 요청받을 수 있다.
- 다른 디바이스에서 구매할 수 있다.

애플 계정에 인앱 구매 히스토리가 남는다.

앱을 지웠다가 깔아도 히스토리를 달라고 하면, 넷플 구독과 같은 정보를 얻을 수 있다.

→ 서비스 서버가 해줄게 없을까? (그렇다면 아이폰 → 안드로이드 기기 변경한다면?)

StoreKit Configuration File 로컬테스트

- 테스트 플라이트에 올린다. (실 결제가 일어나지 않음)
- Sandbox 테스트 계정을 활용한다. (a@a.com ↔ SandBox 가짜 계정으로 결제)

[iOS Sandbox System] → UserDefaults / DB Document(Realm) / Widget

- 인스타그램과 유튜브와 같은 경우 서로 다른 샌드박스를 사용하기 때문에 데이터 공유 불가.
- 휴대폰을 껏다 키게되면 사물함의 위치가 계속 변하게 됨.
- 사물함에는, 4개의 영역이 있게 되는데 우리가 자주 사용하는 영역은 Document영역이다.

### Sandbox 계정

- Appstore 인프라를 사용하지만, 실제 결제가 진행되지 않는 테스트 환경
- 인앱 결제 금액이 청구되지 않는 테스트 계정
- 자동 갱신 구독 테스트
    - 지속 기간 단축
- 중단된 앱 내 구입 테스트
    - iOS 14이상
    - 사용자가 업데이트된 이용 약관에 동의해야하는 경우
    - 만료된 결제 방식을 업데이트 해야하는 경우

Sandbox계정을 활용하여 결제를 진행할 수 있다.

아이폰에도 샌드박스 계정을 확인할 수 있다.


### 인앱 상품 생성

- 현지화 > Localization 추가/제거 가능
- 프로모션 이미지 추가 및 제거
- 앱 심사 정보 추가
    - 앱스토어에 반영은 되지 않는다.

구매 내역 복구

- 서비스 서버: 비소모품 A라는 것을 구매했다는 것을 알고 있다면 굳이 구매 내역 복구를 하지 않아도 된다.

| 클라이언트 |  |  |  | 애플서버 |
| --- | --- | --- | --- | --- |
|  | → | Production URL | → |  |
|  | ← | Status 21007(테스트용 영수증) | ← |  |
|  | → | Sandbox URL | → |  |
|  | ← | Status 0( 영수증 정상) | ← |  |

[영수증 검증]

- 단 시간에 너무 많이 구매 했다면?
    - 서버에서 기록을 할 필요가 있다.
    - 단 시간에 너무 많이 환불
- 안드로이드 > 아이폰
- 오프라인 모드에서 결제

Production URL > 0 > 21007 > SandBoxURL > Receipt HTTP Post

⇒ 이 검증을 자동으로 해주는 것이 `StoreKit2`
